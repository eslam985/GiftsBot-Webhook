// This is a dummy change to force Vercel to rebuild cache.
const express = require('express');
const bodyParser = require('body-parser');
// ุงุณุชูุฑุงุฏ ุจูุงูุงุช ุงูููุชุฌุงุช ูู ููู data.json
// ูุชู ุงุณุชุฎุฏุงู require ูุชุญููู ููู JSON ูุจุงุดุฑุฉ ูู Node.js
const data = require('./data.json');
const products = data.products; // ุงุณุชุฎุฑุงุฌ ูุตูููุฉ ุงูููุชุฌุงุช ูู ุงููุงุฆู
// โฌ๏ธ ูุบูุฑ ุทุฑููุฉ ุชุนุฑูู ุงูุฑูู ููุง
const STORE_CONTACT_NUMBER = '01013080898'; // ุงูุฑูู ููุนุฑุถ ููุต
const STORE_CONTACT_WHATSAPP = '201013080898'; // ุงูุฑูู ุจุงูุชูุณูู ุงูุฏููู (ูุซุงู: 201013080898)
// โฌ๏ธ ุจูุงุก ุฑุงุจุท ูุงุชุณุงุจ ุงููุงุจู ููููุฑ
const WHATSAPP_LINK = `https://wa.me/${STORE_CONTACT_WHATSAPP}`;
/**
 * ุฏุงูุฉ ููุญุตูู ุนูู ุณุนุฑ ููุตู ููุชุฌ ูุนูู ุจูุงุกู ุนูู ุงุณูู.
 * ุชู ุชุญุฏูุซูุง ูุงุณุชุฎุฏุงู ุงูุจุญุซ ุงูุฌุฒุฆู (includes) ุจุฏูุงู ูู ุงูุชุทุงุจู ุงูุชุงู (===).
 * @param {string} productName - ุงุณู ุงูููุชุฌ ุงููุฑุงุฏ ุงูุจุญุซ ุนูู.
 * @returns {string} - ุฑุณุงูุฉ ุชุญุชูู ุนูู ุงูุณุนุฑ ุฃู ุฑุณุงูุฉ ุฎุทุฃ.
 */
const getPrice = (productName) => {
 // ุงูุชุญูู ุงูุฃููู:
 if (!productName || typeof productName !== 'string') {
  return `ุขุณูุ ูุฑุฌู ุชุญุฏูุฏ ุงุณู ุงูููุชุฌ ุจูุถูุญ ูู ุณุคุงูู.`;
 }

 // 1. ุชูุธูู ุงูุงุณู ูู ุฃุญุฑู ุงูุฌุฑ ูุงููุณุงูุงุช
 let cleanProductName = productName.trim();

 // ูุซุงู: ูุญูู "ุจุณูุณูุฉ ูุถุฉ ูุณุงุฆูุฉ" ุฅูู "ุณูุณูุฉ ูุถุฉ ูุณุงุฆูุฉ"
 if (cleanProductName.startsWith('ุจ') && cleanProductName.length > 1) {
  cleanProductName = cleanProductName.substring(1).trim();
 }

 // โฌ๏ธ ุงูุชุบููุฑ ุงูุญุงุณู: ุงุณุชุฎุฏุงู .filter ูุงูู .includes โฌ๏ธ
 // ูุจุญุซ ุนู ุงูููุชุฌุงุช ุงูุชู ูุญุชูู ุงุณููุง ุนูู ุฌุฒุก ูู ุงุณู ุงูููุชุฌ ุงูููุฏุฎู
 const potentialProducts = products.filter(product => {
  // ุงูุจุญุซ ุงูุขู ุณูุณุชุฎุฏู cleanProductName (ุงูุฎุงูู ูู ุงูุจุงุก)
  return product.name.toLowerCase().includes(cleanProductName.toLowerCase().trim());
 });
 // โฌ๏ธ ููุงูุฉ ุงูุชุบููุฑ ุงูุญุงุณู โฌ๏ธ


 // 3. ุงูุชุญูู ูู ูุชูุฌุฉ ุงูุจุญุซ ูุงุฎุชูุงุฑ ุฃูุถู ุชุทุงุจู
 if (potentialProducts.length > 0) {
  // ูุฎุชุงุฑ ุฃูุถู ุชุทุงุจู (ุงูุฃุทูู ูู ุงูุฃูุถูุ ุฃู ูุฎุชุงุฑ ุฃูู ูุงุญุฏ)
  let targetProduct = potentialProducts[0];

  // ุฅุฐุง ูุงู ููุงู ุฃูุซุฑ ูู ููุชุฌุ ูููููุง ุงุณุชุฎุฏุงู ููุทู ูุงุฎุชูุงุฑ ุงูุฃูุฑุจ
  if (potentialProducts.length > 1) {
   // ููุทู ูุงุฎุชูุงุฑ ุงูููุชุฌ ุงูุฐู ูุทุงุจู ุงูุงุณู ุงููุฏุฎู ุจุดูู ูุงูู ุฃููุงู
   const exactMatch = potentialProducts.find(p => p.name.toLowerCase().trim() === cleanProductName.toLowerCase().trim());
   if (exactMatch) {
    targetProduct = exactMatch;
   }
  }

  // โฌ๏ธ ุงูุชุนุฏูู ุงูููุงุฆู ูุฏูุฌ ุฑุงุจุท ุงููุงุชุณุงุจ ุงููุงุจู ููููุฑ โฌ๏ธ
  return `ุณุนุฑ ${targetProduct.name} ูู ${targetProduct.price} ุฌููู.\nุงููุตู: ${targetProduct.description}.\n**ูุทูุจ ุงูููุชุฌุ ูุฑุฌู ุงูุชูุงุตู ูุจุงุดุฑุฉ ูุน ุตุงุญุจ ุงููุชุฌุฑ ุนุจุฑ ุงูุงุชุตุงู ุฃู ูุงุชุณุงุจ:**\n๐ ุฑูู ุงูุชูุงุตู: **[${STORE_CONTACT_NUMBER}](${WHATSAPP_LINK})**`;
 } else {
  // โฌ๏ธ 4. ุฅุฐุง ูู ูุฌุฏู ูุงุณู ููุชุฌุ ูุญุงูู ุงูุจุญุซ ูุงุณู ูุฆุฉ (ููุง ูุงู ุณุงุจูุงู) โฌ๏ธ

  const categoryResult = getCategory(productName);

  if (!categoryResult.includes('ุขุณู') && !categoryResult.includes('ูู ูุถูู')) {
   return categoryResult;
  }

  // 5. ุฅุฐุง ูู ูุฌุฏ ูุง ููุชุฌุงู ููุง ูุฆุฉุ ูุฑุฌุน ุฑุณุงูุฉ ุฎุทุฃ
  return `ุขุณูุ ุงูููุชุฌ ุฃู ุงููุฆุฉ ุจุงุณู "${productName}" ุบูุฑ ููุฌูุฏ/ุฉ ูู ูุงุฆูุฉ ุงููุฏุงูุง ูุฏููุง.`;
 }
};





// ุฎุฑูุทุฉ ูุชุฑุฌูุฉ ุงูุฃุณูุงุก ุงูุนุฑุจูุฉ ุงูุดุงุฆุนุฉ ูููุฆุงุช ุฅูู ุงูุงุณู ุงูุฅูุฌููุฒู ุงููุณุชุฎุฏู ูู data.json
const categoryMap = {
 'ูุฌููุฑุงุช': 'Jewelry',
 'ุฅููุชุฑูููุงุช': 'Electronics',
 'ุงููุชุฑูููุงุช': 'Electronics',
 "ูุฏุงูุง ุฑุฌุงููุฉ": "Men's Gifts",
 // ุฃุถู ุงููุฒูุฏ ูู ุงููุฆุงุช ููุง ุฅุฐุง ูุฒู ุงูุฃูุฑ
};



/**
 * ุฏุงูุฉ ููุญุตูู ุนูู ูุงุฆูุฉ ุจุงูููุชุฌุงุช ูู ูุฆุฉ ูุนููุฉ.
 * @param {string} categoryName - ุงุณู ุงููุฆุฉ ุงููุฑุงุฏ ุงูุจุญุซ ุนููุง (ูุฏ ูููู ุนุฑุจู ุฃู ุฅูุฌููุฒู).
 * @returns {string} - ุฑุณุงูุฉ ุชุญุชูู ุนูู ุงูููุชุฌุงุช ุฃู ุฑุณุงูุฉ ุฎุทุฃ.
 */
const getCategory = (categoryName) => {
 if (!categoryName) {
  return "ูู ูุถูู ุญุฏุฏ ุงุณู ุงููุฆุฉ ุงูุชู ุชุจุญุซ ุนููุง.";
 }

 // โฌ๏ธ ุงูุชุนุฏูู ุงูููุงุฆู ูุงูุญุงุณู ูุฅุฒุงูุฉ ุงูู (ุงูุชุนุฑูู) โฌ๏ธ
 // 1. ุชูุธูู ุงููููุฉ ูู ุงููุณุงูุงุช ูุชุญููููุง ูุญุฑูู ุตุบูุฑุฉ
 let cleanCategoryName = categoryName.toLowerCase().trim();

 // 2. ุฅุฒุงูุฉ "ุงูู" ูู ุจุฏุงูุฉ ุงููููุฉ (ูุญู ูุดููุฉ ุงููุฌููุฑุงุช)
 // ูุชุญูู ููุง ุฅุฐุง ูุงูุช ุชุจุฏุฃ ุจู "ุงู" ููุฏูู ุญุฑู ุขุฎุฑ ุจุนุฏูุง
 if (cleanCategoryName.startsWith('ุงู') && cleanCategoryName.length > 2) {
  cleanCategoryName = cleanCategoryName.substring(2).trim();
 }

 // 3. ูุญุงููุฉ ุชุฑุฌูุฉ ุงูุงุณู ุงูุนุฑุจู ุฅูู ูุธูุฑู ุงูุฅูุฌููุฒู ูู ุงูุฎุฑูุทุฉ
 let searchCategory = categoryMap[cleanCategoryName] || categoryName;

 // ุชูุญูุฏ ุงูุงุณู ุงูุฐู ุณูุจุญุซ ุจู (ุณูุงุก ูุงู 'Jewelry' ุฃู 'Electronics')
 searchCategory = searchCategory.toLowerCase().trim();

 // 4. ุชุตููุฉ ุงูููุชุฌุงุช ุญุณุจ ุงููุฆุฉ
 const filteredProducts = products.filter(product =>
  product.category.toLowerCase().trim() === searchCategory
 );

 // 3. ุงูุชุญูู ูู ูุฌูุฏ ููุชุฌุงุช ูู ุงููุฆุฉ
 if (filteredProducts.length > 0) {
  const productNames = filteredProducts.map(p => `${p.name} (${p.price} ุฌููู)`).join('ุ ');
  // ูุณุชุฎุฏู ุงุณู ุงููุฆุฉ ุงูุฃุตูู ุงูุฐู ุฃุฏุฎูู ุงููุณุชุฎุฏู ูู ุงูุฑุฏ (ุงูุฃูุซุฑ ููุทููุฉ ููุนููู)
  return `ุฅููู ุจุนุถ ุงูููุชุฌุงุช ูู ูุฆุฉ "${categoryName}": ${productNames}.`;
 } else {
  return `ุขุณูุ ูุง ุชูุฌุฏ ุญุงูููุง ูุฏุงูุง ูู ูุฆุฉ "${categoryName}" ูุฏููุง.`;
 }
};




// ... (ูู ููุงูุฉ ููู logic.jsุ ูุจู module.exports) ...
/**
 * ุฏุงูุฉ ููุนุงูุฌุฉ ุทูุจุงุช ุงูุดุฑุงุก ูุชูุฌูู ุงููุณุชุฎุฏู ูุตูุญุฉ ุงูุฏูุน.
 * @param {string} productName - ุงุณู ุงูููุชุฌ ุงูุฐู ูุฑูุฏ ุงููุณุชุฎุฏู ุดุฑุงุกู.
 * @returns {string} - ุฑุณุงูุฉ ุชูุฌูููุฉ ูุน ุฑุงุจุท ุงูุดุฑุงุก.
 */

// ... (ุจุนุฏ ุฏุงูุฉ getCategory)
// โฌ๏ธ ุงุณุชูุจุงู ุงููุชุบูุฑ ุงูุฌุฏูุฏ: originalQuery โฌ๏ธ
const getPriceRange = (min, max, originalQuery) => {
 // 1. ุงุณุชุฎูุงุต ุงููููุฉ ุงูููุฏูุฉ (ุงูุฑูู) ููุท ูู ูุงุฆูุงุช Dialogflow
 let minPrice = (min && typeof min.amount === 'number') ? min.amount : min || 0;
 let maxPrice = (max && typeof max.amount === 'number') ? max.amount : max || Infinity;

 // โฌ๏ธ ุงูููุทู ุงูุญุงุณู: ุฅุฐุง ูุงูุช ุงูุนููุฉ ููููุฏุฉุ ูุญุงูู ูุฑุงุกุฉ ุงูุนููุฉ ูู ุงููุต ุงูุฃุตูู โฌ๏ธ
 // ุฅุฐุง ูุงูุช ููู maxPrice ูู Infinityุ ูุฐุง ูุนูู ุฃู ุงูุนููู ุณุฃู ุนู ุญุฏ ุฃูุตู (ูุซู ุฃูู ูู 300) ููู Dialogflow ูู ูุณุชุฎุฑุฌ ุงูุนููุฉ.
 // ูุจูุง ุฃููุง ูู ููุฉ ุงููุทุงู ุงูุณุนุฑูุ ูุฅู ุฃู ุฑูู ูุณุชุฎุฑุฌู Dialogflow ูู ูุฐู ุงูุญุงูุฉ ูู ุงูุญุฏ ุงูุฃูุตู.

 // ุงูุญู ุงูุฃุจุณุท: ุฅุฐุง ูุงูุช maxPrice ูู Infinity (ุฃู ูู ูุชู ุชุนููููุง) ู minPrice ูู 0ุ 
 // ููุฐุง ูุนูู ุฃู Dialogflow ูู ูุณุชุฎุฑุฌ ุฃู ููู ุนููุฉ ุนูู ุงูุฅุทูุงู.
 // ุจูุง ุฃููุง ุณูุณุชุฎุฏู @sys.number ุงูุขูุ ุณูุชุฌุงูู ุงูููุฏ ุฃุนูุงูุ ููุนูุฏ ููุซุจุงุช.

 // **ูุนุชูุฏ ุนูู ุฃู ุงูุนููู ุณูุณุชุฎุฏู @sys.number (ุฃุฑูุงู ุฎุงู) ุฏุงุฎู Dialogflow**

 // โฌ๏ธ ุงูููุทู ุงูุฌุฏูุฏ ูุชุฌุงูู ุงููุดููุฉ ูุนุฒู ุงูุญู โฌ๏ธ
 if (originalQuery && originalQuery.includes('ุฌููุฉ') && max === undefined && min !== undefined) {
  // ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุชุจ (ุฃูู ูู 300 ุฌููุฉ) ููู Dialogflow ูุดู
  // ุณููุชุฑุถ ุฃู ุงููููุฉ ุงูุชู ุงุณุชุฎุฑุฌุช ูู ุงูุญุฏ ุงูุฃูุตู.
  // ุณูุนูุฏ ููุง ุฅูู ุงูุงุนุชูุงุฏ ุนูู @sys.number
  if (typeof min === 'number' && min > 0) {
   maxPrice = min;
   minPrice = 0;
  }
 }

 // 2. ููุทู ุงูุชุจุงุฏู (ููู ุฌุฏุงู ููุญุงูุชูู)
 if (minPrice > maxPrice && maxPrice !== Infinity) {
  [minPrice, maxPrice] = [maxPrice, minPrice];
 }
 // 3. ุชุตููุฉ ุงูููุชุฌุงุช ุจูุงุกู ุนูู ุงููุทุงู ุงูุณุนุฑู
 const matchingProducts = products.filter(product => {
  return product.price >= minPrice && product.price <= maxPrice;
 });

 // 3. ุจูุงุก ุงูุฑุฏ ุนูู ุงูุนููู
 if (matchingProducts.length === 0) {
  // ูุณุชุฎุฏู minPrice ู maxPrice ุงููุนุฏูุชูู ูู ุงูุฑุฏ
  return `ุนููุงูุ ูุง ุชูุฌุฏ ูุฏุงูุง ูุชุงุญุฉ ูู ูุฐุง ุงููุทุงู ุงูุณุนุฑู (${minPrice} - ${maxPrice} ุฌููู). ูู ูููููู ูุณุงุนุฏุชู ูู ูุทุงู ุขุฎุฑุ`;
 }

 let response = `ููุฏ ูุฌุฏุช ${matchingProducts.length} ููุชุฌุงุช ูู ูุทุงู ุงูููุฒุงููุฉ ุงููุทููุจุฉ (${minPrice} - ${maxPrice} ุฌููู):\n`;

 // ุฅุถุงูุฉ ุฃุณูุงุก ุงูููุชุฌุงุช ูุงูุณุนุฑ ุฅูู ุงูุฑุฏ
 matchingProducts.forEach(product => {
  response += `โข ${product.name} (ุงูุณุนุฑ: ${product.price} ุฌููู)\n`;
 });

 response += `\nูุทูุจ ุฃู ููุชุฌุ ุงูุชุจ ุงุณูู.`;
 return response;
};

// ... (ุชุฃูุฏ ูู ุชุตุฏูุฑ ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ)
module.exports = {
 products,
 getPrice,
 getCategory,
 getPriceRange // โฌ๏ธ ุฅุถุงูุฉ ุงูุฏุงูุฉ ููุชุตุฏูุฑ
}; 